set test "utf_user_trunc"

if {! [installtest_p]} { untested "$test"; return }
if {! [uprobes_p]} { untested "$test"; return }

set ::result_string {utf-16:012345678901234567890123456789012345678Z
utf-16:0123456789012345678901234567890123456789
utf-16:01234567890123456789012345678901234567Î©
utf-16:012345678901234567890123456789012345678
utf-16:0123456789012345678901234567890123456789
utf-16:0123456789012345678901234567890123456â˜º
utf-16:01234567890123456789012345678901234567
utf-16:012345678901234567890123456789012345678
utf-16:0123456789012345678901234567890123456789
utf-16:012345678901234567890123456789012345ðŸ˜ˆ
utf-16:0123456789012345678901234567890123456
utf-16:01234567890123456789012345678901234567
utf-16:012345678901234567890123456789012345678
utf-16:0123456789012345678901234567890123456789
utf-32:012345678901234567890123456789012345678Z
utf-32:0123456789012345678901234567890123456789
utf-32:01234567890123456789012345678901234567Î©
utf-32:012345678901234567890123456789012345678
utf-32:0123456789012345678901234567890123456789
utf-32:0123456789012345678901234567890123456â˜º
utf-32:01234567890123456789012345678901234567
utf-32:012345678901234567890123456789012345678
utf-32:0123456789012345678901234567890123456789
utf-32:012345678901234567890123456789012345ðŸ˜ˆ
utf-32:0123456789012345678901234567890123456
utf-32:01234567890123456789012345678901234567
utf-32:012345678901234567890123456789012345678
utf-32:0123456789012345678901234567890123456789}

set srcfile "$srcdir/$subdir/$test.c"
set stpfile "$srcdir/$subdir/$test.stp"
set exefile "[pwd]/$test.exe"
set test_flags "additional_flags=-g additional_flags=-DMAXSTRINGLEN=41"
set res [target_compile "$srcfile" "$exefile" executable "$test_flags"]
if { $res != "" } {
  verbose "target_compile failed: $res" 2
  fail "$test compile"
  untested "$test"
  return
} else {
  pass "$test compile"
}

foreach runtime [get_runtime_list] {
  if {$runtime != ""} {
    # use module name of 10 chars + \0 to fit in MAXSTRINGLEN
    set module [string range $test 0 9]
    stap_run3 "$test ($runtime)" "$stpfile" -c "$exefile" \
      -DMAXSTRINGLEN=41 --runtime=$runtime -m$module
  } else {
    stap_run3 $test "$stpfile" -c "$exefile" -DMAXSTRINGLEN=41
  }
}
if { $verbose == 0 } { catch { exec rm -f $exefile } }
